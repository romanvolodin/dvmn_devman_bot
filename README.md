# Отправляем уведомления о проверке работ

Скрипт отправляет уведомления о проверке работ на сайте [Devman](https://dvmn.org/)

## Требования

Для запуска вам понадобится Python 3.6 или выше.

Нужен токен для доступа к Devman API. Узнать можно [здесь](https://dvmn.org/api/docs/). Нужна регистрация на сайте.

Необходимо зарегистрировать бота и получить токен для доступа к API Телеграма. Подробная инструкция [как зарегистрировать бота](https://way23.ru/%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-telegram/)

Также необходимо узнать ID чата, в который бот будет слать сообщения. Сделать это можно с помощью бота [Userinfobot](https://telegram.me/userinfobot). Отправьте боту любое сообщение, он в ответ пришлет ID.

## Переменные окружения

Настройки берутся из переменных окружения. Чтобы их определить, создайте файл `.env` рядом с `main.py` и запишите туда данные в таком формате: `ПЕРЕМЕННАЯ=значение`.

Доступные переменные:

- `DVMN_TOKEN` — токен для доступа к Devman API.
- `TG_BOT_TOKEN` — токен бота, который отправлять уведомления.
- `TG_CHAT_ID` — id чата, куда будут отправляться уведомления.
- `LOGGING_LEVEL` — уровень сообщений для логирования. По-умолчанию  `WARNING`, т.е. будут логироваться только предупреждения, ошибки и критические ошибки (`WARNING`, `ERROR`, `CRITICAL`). Для посмотра отладочных сообщений поставьте `DEBUG`.

Пример:

```env
DVMN_TOKEN=5a33ad154500b4efdacc78204317193ec0
TG_BOT_TOKEN=54217500:AAGcctEBWHWQTMZFUeXFKq4JlZuCrn8
TG_CHAT_ID=1234567
LOGGING_LEVEL=DEBUG
```

## Запуск

Скачайте код с GitHub. Установите зависимости:

```sh
pip install -r requirements.txt
```

Запустите скрипт:

```sh
python main.py
```

В случае успешного старта скрипт ничего не выводит и запускает бесконечный цикл. Остановить можно командой `Ctrl + C`.

## Деплой бота на Heroku

Сначала регистрируемся на Heroku. Когда аккаунт создан, переходим к [списку приложений](https://dashboard.heroku.com/apps) и создаем новое. Название не важно, в данном примере приложение будет называться `your-heroku-app`.  

Теперь надо залить репозиторий на Heroku. На данный момент (май 2022) у Heroku сломана интеграция с GitHub, поэтому скачиваем и устанавливаем Heroku CLI. Затем выполняем команды в терминале:

- Логинимся в Heroku
- Переходим в папку репозитория со скриптом
- Добавляем репозиторий heroku-приложения как новый удаленный репозиторий
- Заливаем файлы в Heroku

```bash
heroku login
cd /your/repo/dir/
heroku git:remote -a your-heroku-app
git push heroku main
```

Чтобы проверить, что всё прошло хорошо, посмотрите логи:

```bash
heroku logs --tail
```

Должно быть что-то вроде этого:

```bash
2022-05-20T18:51:43.000000+00:00 app[api]: Build started by user user@example.com
2022-05-20T18:52:12.905874+00:00 app[api]: Deploy fb47ea51 by user user@example.com
2022-05-20T18:52:12.905874+00:00 app[api]: Release v3 created by user user@example.com
2022-05-20T18:52:23.000000+00:00 app[api]: Build succeeded
```

В дашборде приложения, в разделе **Resources**, надо активировать команду `bot python3 main.py`. Нажимаем на иконку карандаша рядом с переключателем, активируем переключатель и нажимаем "Confirm".

Теперь в разделе **Settings → Config Vars** добавляем переменные окружения из `.env`.

И перезапускаем:

```bash
heroku dyno:restart --app your-heroku-app
```

## Цели проекта

Код написан в учебных целях — для курса по Python на сайте [Devman](https://dvmn.org/modules/chat-bots/).
